version: "3.8"

# uffizzi integration
x-uffizzi:
  ingress:
    service: nginx
    port: 8081
services:

  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx-uffizzi:/etc/nginx


  postgres:
   image: postgres
   environment:
     - POSTGRES_USER=postgres
     - POSTGRES_PASSWORD=postgres
     - POSTGRES_DB=iris
     - PGDATA=/tmp
   volumes:
      - postgres_data:/var/lib/postgresql/data/
      - ./uffizzi-db-script/:/docker-entrypoint-initdb.d/
   deploy:
          resources:
            limits:
              memory: 500M

  mindsdb:
    # image: mindsdb/mindsdb
    image: "${MINDSDB_IMAGE}"
    # entrypoint: /bin/sh
    # command:
    #      - "-c"
    #      - "apt update &&
    #         apt install unzip -y &&
    #         wget https://github.com/ShrutiC-git/mindsdb/archive/refs/heads/uffizzi.zip &&
    #         unzip uffizzi.zip && wait &&
    #         rm -rf mindsdb &&
    #         mv mindsdb-uffizzi mindsdb &&
    #         chmod +x mindsdb/ &&
    #         cd mindsdb &&
    #         python -m mindsdb
    #         "
    ports:
      - "47334:47334"
    environment:
      MINDSDB_DOCKER_ENV: "True"
      MINDSDB_STORAGE_DIR: "/mindsdb/var"
      FLASK_DEBUG: "1"
      FLASK_ENV: "develop"
      FLASK_APP: "mindsdb/mindsdb/__main__.py"
      # MDB_CONFIG_CONTENT: '{"api": {"postgres": {"host": "localhost", "password": "postgres", "port": "5432", "user": "postgres", "database": "postgres"}}}'
    # healthcheck:
    #   test:  ["CMD", "curl", "-f", "http://localhost:47334/api/util/ping"]
    #   interval: 30s
    #   timeout: 4s
    #   retries: 100
    deploy:
            resources:
              limits:
                memory: 4000M


  hugginggace_ml_handler:
    image: "${ML_HANDLER_IMAGE}"
    environment:
      # have to share mindsdb database, because it doens't work without it
      MINDSDB_STORAGE_DIR: "/mindsdb/var"
    entrypoint: /bin/sh
    command:
          - "-c"
          - "apt update &&
            apt install unzip -y &&
            wget https://github.com/ShrutiC-git/mindsdb/archive/refs/heads/uffizzi.zip &&
            unzip uffizzi.zip && wait &&
            rm -rf mindsdb &&
            mv mindsdb-uffizzi mindsdb &&
            chmod +x mindsdb/ &&
            chmod +x mindsdb/mindsdb/ &&
            HOST=$$UFFIZZI_URL &&
            python /mindsdb/mindsdb/integrations/handlers_wrapper/ml_handler_service.py"
    deploy:
            resources:
              limits:
                memory: 1000M


  db_handler:
    image: "${DB_HANDLER_IMAGE}"
    entrypoint: /bin/sh
    command:
          - "-c"
          - "apt update &&
            apt install unzip -y &&
            wget https://github.com/ShrutiC-git/mindsdb/archive/refs/heads/uffizzi.zip &&
            unzip uffizzi.zip && wait &&
            rm -rf mindsdb &&
            mv mindsdb-uffizzi mindsdb &&
            chmod +x mindsdb/ &&
            cd mindsdb &&
            chmod +x mindsdb/ &&
            cd mindsdb &&
            cd integrations/handlers_wrapper &&
            HOST=$$UFFIZZI_URL &&
            python db_handler_service.py"
    # healthcheck:
    #   test: ["CMD-SHELL", "sh -c 'pg_isready -U postgres -d postgres'"]
    #   interval: 120s
    #   timeout: 60s
    #   retries: 100
    deploy:
            resources:
              limits:
                memory: 1000M
    environment:
      - 'PARAMS={"connection_data": {"host": "localhost", "port": "5432", "user": "postgres", "password": "postgres", "database": "iris", "ssl": false}, "name": "postgres", "type": "postgres"}'

volumes:
  postgres_data:

